<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>访客登记 - 宿舍管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .card-header {
            background-color: #4e73df;
            color: white;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .btn-primary {
            background-color: #4e73df;
            border-color: #4e73df;
        }
        .btn-primary:hover {
            background-color: #2e59d9;
            border-color: #2e59d9;
        }
        .form-control:focus {
            border-color: #4e73df;
            box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
        }
        .datetime-picker {
            position: relative;
        }
        .datetime-picker .form-control {
            padding-right: 40px;
        }
        .datetime-picker .bi {
            position: absolute;
            right: 10px;
            top: 10px;
            pointer-events: none;
        }
        .search-container {
            position: relative;
        }
        .search-icon {
            position: absolute;
            left: 10px;
            top: 10px;
            z-index: 10;
        }
        .search-input {
            padding-left: 35px;
        }
        .action-buttons .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center header-actions">
        <h2>来访人员</h2>
        <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
            <i class="bi bi-house-door"></i> 回到首页
        </a>
    </div>

    <!-- 主要内容 -->
    <div class="container mt-4">
        <!-- 访客登记卡片 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-person-lines-fill me-2"></i>访客登记管理</h5>
                <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addVisitorModal">
                    <i class="bi bi-plus-circle me-1"></i> 新增访客
                </button>
            </div>

            <div class="card-body">
                <!-- 搜索和筛选区域 -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="search-container">
                            <i class="bi bi-search search-icon"></i>
                            <label for="visitor-search" class="visually-hidden">搜索访客</label>
                            <input type="text" class="form-control search-input" id="visitor-search"
                                   placeholder="输入访客姓名、被访学生学号或姓名..." aria-label="搜索访客">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center h-100">
                            <span class="me-2 fw-medium">状态:</span>
                            <div class="status-filter btn-group">
                                <button type="button" class="btn btn-outline-primary active" data-status="all">全部</button>
                                <button type="button" class="btn btn-outline-success" data-status="active">在楼内</button>
                                <button type="button" class="btn btn-outline-secondary" data-status="departed">已离开</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 访客表格 -->
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="visitorTable">
                        <thead class="table-light">
                            <tr>
                                <th>访客姓名</th>
                                <th>年龄</th>
                                <th>关系</th>
                                <th>被访学生</th>
                                <th>来访时间</th>
                                <th>离开时间</th>
                                <th>状态</th>
                                <th>联系方式</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="visitorTableBody">
                            <!-- 数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>

                <!-- 加载状态 -->
                <div id="loadingSpinner" class="text-center my-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2">正在加载访客数据...</p>
                </div>

                <!-- 无数据提示 -->
                <div id="noDataMessage" class="text-center py-4 d-none">
                    <i class="bi bi-exclamation-circle fs-1 text-muted"></i>
                    <p class="mt-2 text-muted">暂无访客数据</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加访客模态框 -->
<div class="modal fade" id="addVisitorModal" tabindex="-1" aria-labelledby="addVisitorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addVisitorModalLabel"><i class="bi bi-person-plus me-2"></i>登记新访客</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addVisitorForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="visitor-name" class="form-label">访客姓名 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="visitor-name" required>
                            </div>
                            <div class="mb-3">
                                <label for="visitor-phone" class="form-label">联系电话 <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="visitor-phone" required>
                            </div>
                            <div class="mb-3">
                                <label for="visitor-relation" class="form-label">与被访学生关系</label>
                                <select class="form-select" id="visitor-relation">
                                    <option value="">请选择关系</option>
                                    <option value="家人">家人</option>
                                    <option value="朋友">朋友</option>
                                    <option value="同学">同学</option>
                                    <option value="老师">老师</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="visitor-age" class="form-label">年龄</label>
                                <input type="number" class="form-control" id="visitor-age" min="1" max="120">
                            </div>
                            <div class="mb-3">
                                <label for="visitor-gender" class="form-label">性别</label>
                                <select class="form-select" id="visitor-gender">
                                    <option value="">请选择性别</option>
                                    <option value="男">男</option>
                                    <option value="女">女</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="visited-student" class="form-label">被访学生 <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="visited-student" placeholder="输入学号或姓名" required>
                                    <button class="btn btn-outline-primary" type="button" id="findStudentBtn">
                                        <i class="bi bi-search me-1"></i> 查找
                                    </button>
                                </div>
                                <div id="studentResult" class="mt-2"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="visit-purpose" class="form-label">来访事由</label>
                                <textarea class="form-control" id="visit-purpose" rows="1"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3 datetime-picker">
                                <label for="visit-time" class="form-label">来访时间 <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" id="visit-time" required>
                                <i class="bi bi-calendar"></i>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3 datetime-picker">
                                <label for="estimated-leave-time" class="form-label">预计离开时间</label>
                                <input type="datetime-local" class="form-control" id="estimated-leave-time">
                                <i class="bi bi-calendar"></i>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="visit-notes" class="form-label">备注信息</label>
                        <textarea class="form-control" id="visit-notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary" id="submitVisitorBtn">
                        <i class="bi bi-check-circle me-1"></i> 提交登记
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除访客 <span id="visitorName"></span> 的记录吗？</p>
                <p class="text-danger">此操作不可撤销，将永久删除该访客的所有信息。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
            </div>
        </div>
    </div>
</div>

<!-- 操作成功提示 -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong class="me-auto">操作成功</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            访客登记已成功提交！
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 初始化组件
    const addVisitorModal = new bootstrap.Modal(document.getElementById('addVisitorModal'));
    const successToast = new bootstrap.Toast(document.getElementById('successToast'));
    const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    let currentStatusFilter = 'all';
    let currentVisitorToDelete = null;

    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
        // 加载访客数据
        loadVisitors();

        // 设置默认时间为当前时间
        const now = new Date();
        const timeString = now.toISOString().slice(0, 16);
        document.getElementById('visit-time').value = timeString;
        // 设置预计离开时间为2小时后
        const leaveTime = new Date(now.getTime() + 2 * 60 * 60 * 1000),
            leaveTimeString = leaveTime.toISOString().slice(0, 16);
        document.getElementById('estimated-leave-time').value = leaveTimeString;

        // 搜索框事件监听
        document.getElementById('visitor-search').addEventListener('input', function() {
            const query = this.value.trim();
            loadVisitors(query, currentStatusFilter);
        });

        // 状态筛选按钮事件
        document.querySelectorAll('.status-filter button').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelector('.status-filter .active').classList.remove('active');
                this.classList.add('active');
                currentStatusFilter = this.dataset.status;
                const query = document.getElementById('visitor-search').value.trim();
                loadVisitors(query, currentStatusFilter);
            });
        });

        // 查找学生按钮事件
        document.getElementById('findStudentBtn').addEventListener('click', searchStudents);
    });

    // 加载访客数据
    async function loadVisitors(query = '', status = 'all') {
        try {
            showLoading(true);

            const url = `/api/visitors?query=${encodeURIComponent(query)}&status=${status}`;
            const response = await fetch(url);

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || '获取数据失败');
            }

            const result = await response.json();

            if (!result.success) {
                throw new Error(result.message || '数据加载失败');
            }

            updateVisitorTable(result.data);

        } catch (error) {
            console.error('加载访客列表失败:', error);
            showError(`加载失败: ${error.message}`);
        } finally {
            showLoading(false);
        }
    }

    // 更新访客表格
    function updateVisitorTable(visitors) {
        const tableBody = document.getElementById('visitorTableBody');
        tableBody.innerHTML = '';

        if (visitors.length === 0) {
            document.getElementById('noDataMessage').classList.remove('d-none');
            return;
        }

        document.getElementById('noDataMessage').classList.add('d-none');

        visitors.forEach(visitor => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${visitor.name || '-'}</td>
                <td>${visitor.age || '-'}</td>
                <td>${visitor.relation || '-'}</td>
                <td>${visitor.host_name ? `${visitor.host_name} (${visitor.host_sno})` : visitor.host_sno || '-'}</td>
                <td>${formatDateTime(visitor.enter_time)}</td>
                <td>${visitor.leave_time ? formatDateTime(visitor.leave_time) : '-'}</td>
                <td>
                    <span class="visitor-status ${visitor.status === 'active' ? 'status-active' : 'status-departed'}"></span>
                    ${visitor.status === 'active' ? '在楼内' : '已离开'}
                </td>
                <td>${visitor.phone || '-'}</td>
                <td class="action-buttons">
                    ${visitor.status === 'active' ?
                        `<button class="btn btn-sm btn-success me-1" onclick="markVisitorDepart('${visitor.id}')">
                            <i class="bi bi-door-open"></i> 离开
                        </button>` : ''
                    }
                    <button class="btn btn-sm btn-danger" onclick="confirmDeleteVisitor('${visitor.id}', '${visitor.name}')">
                        <i class="bi bi-trash"></i> 删除
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // 格式化日期时间
    function formatDateTime(dateTimeString) {
        if (!dateTimeString) return '-';
        const date = new Date(dateTimeString);
        return date.toLocaleString('zh-CN');
    }

    // 显示加载状态
    function showLoading(show) {
        document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
    }

    // 搜索学生
    async function searchStudents() {
        const query = document.getElementById('visited-student').value.trim();
        if (!query) {
            showError('请输入学号或姓名进行搜索');
            return;
        }

        const resultDiv = document.getElementById('studentResult');
        resultDiv.innerHTML = '<div class="text-center py-2"><div class="spinner-border spinner-border-sm text-primary" role="status"></div> 搜索中...</div>';

        try {
            const response = await fetch(`/api/students?query=${encodeURIComponent(query)}`);
            const students = await response.json();

            if (!students || students.length === 0) {
                resultDiv.innerHTML = '<div class="alert alert-warning py-2">未找到匹配的学生</div>';
                return;
            }

            let html = '<div class="list-group">';
            students.forEach(student => {
                html += `
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                       data-sno="${student.sno}"
                       onclick="selectStudent(this)">
                        <div>
                            <strong>${student.name || '未知'}</strong> (${student.sno})<br>
                            <small class="text-muted">寝室: ${student.dorm || '未分配'}</small>
                        </div>
                        <i class="bi bi-chevron-right"></i>
                    </a>
                `;
            });
            html += '</div>';
            resultDiv.innerHTML = html;

        } catch (error) {
            resultDiv.innerHTML = `<div class="alert alert-danger py-2">搜索失败: ${error.message}</div>`;
        }
    }

    // 选择学生
    function selectStudent(element) {
        const studentElement = element.closest('.list-group-item');
        const sno = studentElement.dataset.sno;
        const name = studentElement.querySelector('strong').textContent;

        const input = document.getElementById('visited-student');
        input.value = `${name} (${sno})`;
        input.dataset.sno = sno;
        document.getElementById('studentResult').innerHTML = '';
    }

    // 提交访客表单
    document.getElementById('addVisitorForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitBtn = document.getElementById('submitVisitorBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 提交中...';

        try {
            // 获取并验证学生学号
            const studentInput = document.getElementById('visited-student');
            const studentId = studentInput.dataset.sno;
            if (!studentId) {
                throw new Error('请选择有效的被访学生');
            }

            // 准备表单数据
            const formData = {
                visitor_name: document.getElementById('visitor-name').value.trim(),
                visitor_phone: document.getElementById('visitor-phone').value.trim(),
                visitor_relation: document.getElementById('visitor-relation').value,
                visitor_age: document.getElementById('visitor-age').value || null,
                visited_student: studentId,
                visit_time: document.getElementById('visit-time').value,
                visit_notes: document.getElementById('visit-notes').value.trim() || null
            };

            // 验证必填字段
            if (!formData.visitor_name || !formData.visitor_phone || !formData.visit_time) {
                throw new Error('请填写所有必填字段（标有*的字段）');
            }

            // 发送请求
            const response = await fetch('/add_visitor', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || '提交失败');
            }

            // 显示成功提示
            showSuccess(result.message || '访客登记成功！');

            // 关闭模态框并刷新数据
            setTimeout(() => {
                addVisitorModal.hide();
                loadVisitors();
            }, 1500);

        } catch (error) {
            console.error('提交失败:', error);
            showError(error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i> 提交登记';
        }
    });

    // 标记访客离开
    async function markVisitorDepart(visitorId) {
        if (!confirm('确认访客已离开宿舍楼？此操作不可撤销。')) return;

        try {
            const response = await fetch(`/mark_visitor_depart/${visitorId}`, {
                method: 'POST'
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || '操作失败');
            }

            // 显示成功消息
            document.getElementById('toastMessage').textContent = result.message || '访客离开登记成功！';
            successToast.show();

            // 刷新数据
            setTimeout(() => {
                loadVisitors();
            }, 1500);

        } catch (error) {
            console.error('操作失败:', error);
            showError(error.message);
        }
    }

    // 确认删除访客
    function confirmDeleteVisitor(visitorId, visitorName) {
        currentVisitorToDelete = visitorId;
        document.getElementById('visitorName').textContent = visitorName;
        deleteConfirmModal.show();
    }

    // 执行删除操作
    document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
        if (!currentVisitorToDelete) return;

        try {
            const response = await fetch(`/delete_visitor/${currentVisitorToDelete}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || '删除失败');
            }

            // 显示成功消息
            document.getElementById('toastMessage').textContent = result.message || '访客记录已删除！';
            successToast.show();

            // 关闭模态框并刷新数据
            deleteConfirmModal.hide();
            setTimeout(() => {
                loadVisitors();
            }, 1500);

        } catch (error) {
            console.error('删除失败:', error);
            showError(error.message);
        } finally {
            currentVisitorToDelete = null;
        }
    });

    // 显示成功提示
    function showSuccess(message) {
        document.getElementById('toastMessage').textContent = message;
        successToast.show();
    }

    // 显示错误提示
    function showError(message) {
        const toast = document.createElement('div');
        toast.className = 'toast show position-fixed top-0 end-0 m-3 bg-danger text-white';
        toast.style.zIndex = '1090';
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
</script>
</body>
</html>